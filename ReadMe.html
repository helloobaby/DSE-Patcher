<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta content="en-us" http-equiv="Content-Language" />
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<style type="text/css">

.leftpane {
    width: 25%;
    height: 100%;
    float: left;
    background-color: white;
    border-collapse: collapse;
}

.middlepane {
    width: 50%;
    min-width: 810px;
    height: 100%;
    float: left;
    background-color: white;
    border-collapse: collapse;
    display: inline-block;
    text-align: justify;
}

.rightpane {
  width: 25%;
  height: 100%;
  position: relative;
  float: right;
  background-color: white;
  border-collapse: collapse;
}

ul {
	list-style-type: square;
	margin-left: 20px;
	padding-left: 0px;
}

h1 {
	background-color: #ffffff;
	text-align: left;
	font-family: Verdana, Geneva, Tahoma, sans-serif;
	font-size: small;
	font-weight: bold;
	width: 100%;
}

t1 {
	background-color: #ffffff;
	text-align: left;
	font-family: Verdana, Geneva, Tahoma, sans-serif;
	font-size: small;
	width: 100%;
}

pre {
	color: #000;
	background-color: #fbedbb;
	padding: 6px;
	font: 13px Consolas, monospace, mono;
	white-space: pre;
	overflow: auto;
	border: solid 1px #000000;
	width: 100%;
	box-shadow: 4px 4px 4px silver;
}

code {
	color: #900;
	font: 15px Consolas, monospace, mono;
}

.code-string {
	font-family: "Courier New", Courier, monospace;
	font-size: small;
	color: #800080;
}

.code-keyword {
	font-family: "Courier New", Courier, monospace;
	font-size: small;
	color: #00f;
}

.code-comment {
	font-family: "Courier New", Courier, monospace;
	font-size: small;
	font-style: italic;
	color: #008000;
}
</style>
</head>

<body>
<div class="leftpane"><h1></h1></div>
<div class="middlepane">
<h1><br><br>
Topic Overview<br>
------------------</h1>
<t1>
<a href="#topic1">1.) Introduction</a><br>
<a href="#topic2">2.) Usage Instructions</a><br>
<a href="#topic3">3.) Patch DSE on Windows Vista and Windows 7</a><br>
<a href="#topic4">4.) Patch DSE on Windows 8 and later up to Windows 10 Version 1703</a><br>
<a href="#topic5">5.) Patch DSE on Windows 10 Version 1709 and later</a><br>
<a href="#topic6">6.) Use BYOVD to patch kernel address space</a><br>
<a href="#topic7">7.) RTCore64 v4.6.2</a><br>
<a href="#topic8">8.) DBUtil v2.3</a><br>
<a href="#topic9">9.) DBUtil v2.5</a><br>
<a href="#topic10">10.) DBUtil v2.6</a><br>
<a href="#topic11">11.) DBUtil v2.7</a><br>
<a href="#topic12">12.) Will all these vulnerable drivers still work?</a><br>
<a href="#topic13">13.) How to block vulnerable drivers?</a><br>
<a href="#topic14">14.) Credits and Download Link</a><br>
<br>
</t1>
<a name="topic1"></a>
<br>
<h1>
1.) Introduction<br>
-------------------<br>
</h1>
<t1>Driver Signature Enforcement (DSE) was introduced by Microsoft starting with Windows Vista x64. DSE
is a security feature of the operating system, which ensures that only valid signed drivers are
loaded. To install unsigned drivers the DSE security feature has to be disabled. DSE-Patcher can be
used to disable DSE on all 64-bit operating systems starting with Windows Vista and later. We
developed DSE-Patcher to show the interested coder how easy it is to use known vulnerabilities and
change memory in kernel address space.<br>
<br>
</t1>
<a name="topic2"></a>
<br>
<h1>
2.) Usage Instructions<br>
-------------------------<br>
</h1>
<t1>DSE-Patcher should be run with administrative rights. Directly after the start of DSE-Patcher the
first driver in the vulnerable drivers list is used to check the actual Driver Signature Enforcement
status. We use RTCore64 on first time startup, because it is the most compatible and reliable driver
at the moment. It supports all operating systems starting with Windows Vista x64. Pay attention that
this tool is designed to x64 OS versions only, because on x86 DSE is not enforced by the OS at all.<br>
<br>
After the tool is started you should see detailed data about the actual DSE status. This will look
like follows:<br>
<br>
<img src="images/DSE-Patcher_Win7.png" style="border:0px;margin:0px 0px 0px 50px"/>
<img src="images/DSE-Patcher_Win10.png" style="border:0px;margin:0px 50px 0px 0px;float:right"/><br>
<br>
DSE-Patcher supports 3 main tasks. We can disable, enable and restore the DSE status by the
corresponding buttons inside the dialog. The 3 buttons have the following functionality:<br>
<ul>
<li><em>Disable DSE</em> will disable Driver Signature Enforcement and sets the variable to the value
<em>DSE Disable Value</em>.</li>
<li><em>Enable DSE</em> will enable Driver Signature Enforcement and sets the variable to the value
<em>DSE Enable Value</em>.</li>
<li><em>Restore DSE</em> will reset Driver Signature Enforcement and sets the variable to the value
<em>DSE Original Value</em>.</li>
</ul>
The values which are set by DSE-Patcher can be looked up in the <em>DSE Patch Data</em> section. The
<em>DSE Original Value</em> is saved in a global variable on the first startup of DSE-Patcher. It is
recommended to restore the DSE value to the original saved one after your own unsigned driver was
loaded. Normally you would click on <em>Disable DSE</em>, load your own unsigned driver and after that
click on <em>Restore DSE</em> to restore the original DSE state. On Windows 8 or later <code>g_CiOptions</code> is
protected by PatchGuard. If the value is modified for too long Windows will show a blue screen.
Therefore we should load our unsigned driver as fast as possible and reenable DSE afterwards.<br>
<br>
The <em>DSE Actual Value</em> is the value that shows the momentary DSE status. The image base and patch
addresses are calculated by the virtual kernel memory address based on the shown module name.
This is <em>NTOSKRNL.EXE</em> for Windows Vista and Windows 7 and <em>CI.DLL</em> for Windows 8 or later. Pay
attention that the DSE disable and enable values may differ from one OS to the other. This also
depends on the operating system version like we will explain in the following chapter.<br>
<br>
All installed vulnerable drivers will be cleanly uninstalled after DSE-Patcher has finished its
mission. Some drivers like DBUtil v2.3 have some unloading problems, which are related to the
driver and its unsupported stopping capability. In Windows 10 the service is removed on the next
reboot, but the driver sys file has to be deleted manually by the user after the next reboot.<br>
<br>
</t1>
<a id="topic3"></a>
<br>
<h1>
3.) Patch DSE on Windows Vista and Windows 7<br>
---------------------------------------------------<br>
</h1>
<t1>To patch DSE on Windows Vista and Windows 7, we have to change the variable <code>g_CiEnabled</code> in
<em>ntoskrnl.exe</em>. If DSE is enabled the variable is set to 1, otherwise it is zero. To calculate
and retrieve the variable we search for the byte sequence <code>EB 06 88 1D</code> inside <em>ntoskrnl.exe</em>,
which contains the jump, jump location <code>loc_1403F5B82</code> and the move instruction in the following
assembler code:<br>
<br>
<img src="images/g_CiEnabled.png"/><br>
<br>
Directly after this byte sequence the address of <code>g_CiEnabled</code> is located. Based on this offset we
then calculate the variable address inside the kernel address space and patch it. Pay attention that
the patch may not work on checked debug builds of the operating system, because the byte sequence is
not found at all or is found at an invalid offset.<br>
<br>
</t1>
<a id="topic4"></a>
<br>
<h1>
4.) Patch DSE on Windows 8 and later up to Windows 10 Version 1703<br>
--------------------------------------------------------------------------<br>
</h1>
<t1>Starting with Windows 8 the DSE concept was slightly changed in comparison to Windows Vista and
Windows 7. The old variable <code>g_CiEnabled</code> is now gone and can not be used anymore to circumvent DSE.
To patch DSE on Windows 8 and later, we have to change the variable <code>g_CiOptions</code> in <em>ci.dll</em>. If
DSE is enabled the variable is set to 6, otherwise it is zero. Pay attention that <code>g_CiOptions</code>
can also have many other values and combination of flags, which not all are known to the public. For
example during the Windows setup stage, the variable value can also change to something other than 6
if DSE is enabled. For these cases we implemented the restore feature of DSE-Patcher, which saves
the original DSE value on first startup and restores it later on. To calculate and retrieve the
variable we first search for a jump instruction with a length of 5 bytes inside the function
<code>CiInitialize</code>.<br>
<br>
<img src="images/g_CiOptions1_Win8.png"/><br>
<br>
We follow the jump to the function <code>CipInitialize</code> and search for the byte sequence <code>89 0D</code> inside
the function <code>CipInitialize</code>, which contains the <code>g_CiOptions</code> move instruction in the following
assembler code:<br>
<br>
<img src="images/g_CiOptions2_Win8.png"/><br>
<br>
Directly after this byte sequence the address of <code>g_CiOptions</code> is located. Based on this offset we
then calculate the variable address inside the kernel address space and patch it. This works with
Windows 8 and later up to Windows 10 Version 1703. Pay attention that the patch may not work on
checked debug builds of the operating system, because the byte sequence is not found at all or is
found at an invalid offset.<br>
<br>
</t1>
<a id="topic5"></a>
<br>
<h1>
5.) Patch DSE on Windows 10 Version 1709 and later<br>
--------------------------------------------------------<br>
</h1>
<t1>In Windows 10 Version 1709 the jump to <code>CipInitialize</code> is replaced by a call instruction. In
addition Windows 10 Build 21H2 started to use calls for feature staging initialization before our
target call. Therefore we have to check for the call instruction and for all function parameters to
retrieve the correct code location. To calculate and retrieve the <code>g_CiOptions</code> variable we first
search for the function parameters and the call instruction with a length of 5 bytes inside the
function <code>CiInitialize</code>.<br>
<br>
<img src="images/g_CiOptions1_Win10_1709.png"/><br>
<br>
We follow the call to the function <code>CipInitialize</code> and search for the byte sequence <code>89 0D</code> inside
the function <code>CipInitialize</code>, which contains the <code>g_CiOptions</code> move instruction in the following
assembler code:<br>
<br>
<img src="images/g_CiOptions2_Win10_1709.png"/><br>
<br>
Directly after this byte sequence the address of <code>g_CiOptions</code> is located. Based on this offset we
then calculate the variable address inside the kernel address space and patch it. Pay attention that
the patch may not work on checked debug builds of the operating system, because the byte sequence is
not found at all or is found at an invalid offset.<br>
<br>
The aforementioned feature staging initialization calls in <code>CiInitialize</code> before our target call
will look like follows on Windows 10 Build 21H2:<br>
<br>
<img src="images/g_CiOptions1_Win10_21H2.png"/><br>
<br>
</t1>
<a id="topic6"></a>
<br>
<h1>
6.) Use BYOVD to patch kernel address space<br>
-------------------------------------------------<br>
</h1>
<t1>To apply a patch for the variables <code>g_CiEnabled</code> and <code>g_CiOptions</code> we have to access the kernel
address space, which is protected from user mode applications like DSE-Patcher. A simple way to do
a memory patch from user mode is by using a driver that can access the kernel address space. In
theory we would be able to code our own driver to do the magic, but this one will also not load due
to enabled DSE. Therefore the best approach in our case would be to use an already signed driver,
which can write memory. Here the <em>Bring Your Own Vulnerable Driver</em> (BYOVD) exploits come to mind.
The exploits use a vulnerable, fully signed driver, which is first loaded and after that an exploit
is run to read or write kernel address space. What sounds complicated first, will be an easy task if
you look at the source code of tools like DSEFix, KDU or DSE-Patcher. All of the vulnerable drivers
used by DSE-Patcher are described in the following chapters.<br>
<br>
</t1>
<a id="topic7"></a>
<br>
<h1>
7.) RTCore64 v4.6.2<br>
-----------------------<br>
</h1>
<t1>The vulnerable driver RTCore64 v4.6.2 is shipped with MSI Afterburner v4.6.2 Build 15658 Beta 2. The
download is still available at the following URL:<br>
<br>
<a href="http://download-eu2.guru3d.com/afterburner/[Guru3D.com]-MSIAfterburnerSetup462Beta2.zip">http://download-eu2.guru3d.com/afterburner/[Guru3D.com]-MSIAfterburnerSetup462Beta2.zip</a><br>
<br>
You only have to unpack the ZIP file and open <em>MSIAfterburnerSetup462Beta2.exe</em> with 7-Zip. Directly
in the root of the archive we can find the vulnerable <em>RTCore64.sys</em> driver. The RTCore64 v4.6.2
driver file has the following properties:<br>
<pre>
<span class="code-keyword">Name    :</span> RTCore64.sys
<span class="code-keyword">Type    :</span> Driver sys file
<span class="code-keyword">CVE ID  :</span> CVE-2019-16098
<span class="code-keyword">SHA-1   :</span> F6F11AD2CD2B0CF95ED42324876BEE1D83E01775
<span class="code-keyword">SHA-256 :</span> 01AA278B07B58DC46C84BD0B1B5C8E9EE4E62EA0BF7A695862444AF32E87F1FD
<span class="code-keyword">MD5     :</span> 2D8E4F38B36C334D0A32A7324832501D
</pre>
The vulnerability exists since 2019 and allows authenticated users to read and write to arbitrary
memory, I/O ports and MSRs. This can be exploited for privilege escalation and code execution under
high privileges. We only use the driver to read and write the DSE variable to disable Driver
Signature Enforcement.<br>
<br>
To start the magic we simply install the driver, open a device handle to it and send the I/O control
code <code>0x80002048</code> for memory reads and <code>0x8000204C</code> for memory writes. RTCore64 supports Windows Vista
and later.<br>
<br>
</t1>
<a id="topic8"></a>
<br>
<h1>
8.) DBUtil v2.3<br>
-----------------<br>
</h1>
<t1>The vulnerable driver DBUtil v2.3 is shipped with many Dell tools. After a quick search we found the
driver in the Dell BIOS update tool v1.0.2 (11 Jun 2019), v1.0.3 (15 Jul 2019) and v1.1.3 (27 Sep
2019) for OptiPlex 7070 systems. As usual the downloads are still available at the following URLs:<br>
<br>
<a href="https://dl.dell.com/FOLDER05600255M/1/OptiPlex_7070_1.0.2.exe">https://dl.dell.com/FOLDER05600255M/1/OptiPlex_7070_1.0.2.exe</a><br>
<a href="https://dl.dell.com/FOLDER05648416M/1/OptiPlex_7070_1.0.3.exe">https://dl.dell.com/FOLDER05648416M/1/OptiPlex_7070_1.0.3.exe</a><br>
<a href="https://dl.dell.com/FOLDER05780067M/1/OptiPlex_7070_1.1.3.exe">https://dl.dell.com/FOLDER05780067M/1/OptiPlex_7070_1.1.3.exe</a><br>
<br>
We can get there from the Dell driver search pages at the following URLs:<br>
<br>
<a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=mtc81">https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=mtc81</a><br>
<a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=c6fh4">https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=c6fh4</a><br>
<a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=6fd9t">https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=6fd9t</a><br>
<br>
Extracting the driver from the executable is a bit more complicated. We have to load the executable
<em>OptiPlex_7070_1.0.2.exe</em> in OllyDbg and stop execution directly after the driver unpacking is
finished. To manually unpack DBUtil v2.3 follow these steps:<br>
<ul>
<li>Attention: These steps have to be done on an x64 version of Windows, otherwise the 32 bit driver
instead of the 64 bit driver is unpacked!</li>
<li>install and run OllyDbg v1.10 as administrator</li>
<li>Menu > File > Open > select <em>OptiPlex_7070_1.0.2.exe</em> > Open</li>
<li>right click the disassembler window > Search for > Name (label) in current module</li>
<li>in the <em>Names</em> window type <code>OpenServiceA</code> > right click it > Find references to import > right
click > Follow in Disassembler</li>
<li>press <em>F2</em> to set a breakpoint on <code>OpenServiceA</code></li>
<li>press <em>F9</em> to run the executable<br>
Even if we have no Dell machine the executable will run and unpack the driver for us.</li>
<li>the executable will stop execution and hit our breakpoint at <code>OpenServiceA</code></li>
<li>press <em>F8</em> one time to single step > in the register window right click on the value of <code>EAX</code> and
choose "Zero"<br>
This will zero a valid handle returned from <code>OpenServiceA</code> function call. Only without a valid
handle the driver will unpack itself more than once. The DBUtil v2.3 only unpacks itself for the
first time the executable is run and after that stays resident in memory until the next reboot.</li>
<li>continue to single step with <em>F8</em> until after the next OptiPlex call</li>
<li>the disassembler window should look like follows:</li>
</ul>
<img src="images/DBUtil_v2.3_unpack_driver.png"/><br>
<ul>
<li>directly after the call to OptiPlex.000A4190 we can find the unpacked driver at
<em>C:\Users\&ltUserName&gt\AppData\Local\Temp\DBUtil_2_3.Sys</em></li>
<li>we can now copy the driver and close OllyDbg</li>
</ul>
The DBUtil v2.3 driver file has the following properties:<br>
<pre>
<span class="code-keyword">Name    :</span> DBUtil_2_3.Sys
<span class="code-keyword">Type    :</span> Driver sys file
<span class="code-keyword">CVE ID  :</span> CVE-2021-21551
<span class="code-keyword">SHA-1   :</span> C948AE14761095E4D76B55D9DE86412258BE7AFD
<span class="code-keyword">SHA-256 :</span> 0296E2CE999E67C76352613A718E11516FE1B0EFC3FFDB8918FC999DD76A73A5
<span class="code-keyword">MD5     :</span> C996D7971C49252C582171D9380360F2
</pre>
The vulnerability exists since 2021 and allows authenticated users to read and write to arbitrary
memory. This can be exploited for privilege escalation and code execution under high privileges.
We only use the driver to read and write the DSE variable to disable Driver Signature Enforcement.<br>
<br>
We simply install the driver, open a device handle to it and send the I/O control code <code>0x9B0C1EC4</code>
for memory reads and <code>0x9B0C1EC8</code> for memory writes. DBUtil v2.3 supports Windows Vista and later
up to Windows 11 Build 21H2. Pay attention that the driver does not support Windows 11 Build 22H2,
because the driver blocklist is correctly updated by Microsoft. This will block the driver from
loading. In addition the driver can only be manually deleted on Windows 10 after a reboot, because
it is not stoppable and running. On Windows 7 the deletion works without any problems.<br>
<br>
</t1>
<a id="topic9"></a>
<br>
<h1>
9.) DBUtil v2.5<br>
-----------------</h1>
<t1>The vulnerable driver DBUtil v2.5 is shipped with many Dell tools. We will find the driver in the
Dell BIOS update tools v1.3.1 (09 Apr 2020), v1.4.4 (30 Jun 2020), v1.5.0 (09 Sep 2020), v1.5.1
(30 Sep 2020) and v1.7.0 (20 Nov 2020) for OptiPlex 7070 systems. Here also the downloads are still
available at the following URLs:<br>
<br>
<a href="https://dl.dell.com/FOLDER06193974M/1/OptiPlex_7070_1.3.1.exe">https://dl.dell.com/FOLDER06193974M/1/OptiPlex_7070_1.3.1.exe</a><br>
<a href="https://dl.dell.com/FOLDER06312901M/1/OptiPlex_7070_1.4.4.exe">https://dl.dell.com/FOLDER06312901M/1/OptiPlex_7070_1.4.4.exe</a><br>
<a href="https://dl.dell.com/FOLDER06364814M/1/OptiPlex_7070_1.5.0.exe">https://dl.dell.com/FOLDER06364814M/1/OptiPlex_7070_1.5.0.exe</a><br>
<a href="https://dl.dell.com/FOLDER06597528M/1/OptiPlex_7070_1.5.1.exe">https://dl.dell.com/FOLDER06597528M/1/OptiPlex_7070_1.5.1.exe</a><br>
<a href="https://dl.dell.com/FOLDER06708159M/1/OptiPlex_7070_1.7.0.exe">https://dl.dell.com/FOLDER06708159M/1/OptiPlex_7070_1.7.0.exe</a><br>
<br>
We can get there from the Dell driver search pages at the following URLs:<br>
<br>
<a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=g5cnt">https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=g5cnt</a><br>
<a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=pg9gp">https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=pg9gp</a><br>
<a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=jy83m">https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=jy83m</a><br>
<a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=5kjvt">https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=5kjvt</a><br>
<a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=jyjfc">https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=jyjfc</a><br>
<br>
Extracting the driver from the executable is a bit more complicated. We have to load the executable
<em>OptiPlex_7070_1.3.1.exe</em> in OllyDbg and stop execution directly after the driver unpacking is
finished. To manually unpack DBUtil v2.5 follow these steps:<br>
<ul>
<li>Attention: These steps have to be done on an x64 version of Windows, otherwise the 32 bit driver
instead of the 64 bit driver is unpacked! We also can not use Windows 7 anymore, because some DLL
imports are missing.</li>
<li>install and run OllyDbg v1.10 as administrator</li>
<li>Menu > File > Open > select <em>OptiPlex_7070_1.3.1.exe</em> > Open</li>
<li>right click the disassembler window > Search for > Name (label) in current module</li>
<li>in the <em>Names</em> window type <code>CreateProcessA</code> > right click it > Find references to import > right
click > Set breakpoint on every command</li>
<li>go to the disassembler window and press <em>F9</em> to run the executable<br>
Even if we have no Dell machine the executable will run and unpack the driver for us.</li>
<li>the executable will stop execution and hit our breakpoint at <code>CreateProcessA</code></li>
<li>the disassembler window should look like follows:</li>
</ul>
<img src="images/DBUtil_v2.5_unpack_driver.png"/><br>
<ul>
<li>after the breakpoint has triggered we can find the unpacked driver files in the directory
<em>C:\Users\&ltUserName&gt\AppData\Local\Temp</em></li>
<li>the driver consists of the following files:</li>
<ul>
<li>C9632CF058AE4321B6B0B5EA39B710FE</li>
<li>DBUtilDrv2.cat</li>
<li>DBUtilDrv2.inf</li>
<li>DBUtilDrv2.Sys</li>
</ul>
The file named <em>C9632CF058AE4321B6B0B5EA39B710FE</em> is an executable that is launched by a call to
<code>CreateProcessA</code>. This exe takes the INF file path as first argument to install the driver.
<li>we can now copy the driver files and close OllyDbg</li>
</ul>
The DBUtil v2.5 driver files have the following properties:<br>
<pre>
<span class="code-keyword">Name    :</span> DBUtilDrv2.Sys
<span class="code-keyword">Type    :</span> Driver sys file
<span class="code-keyword">CVE ID  :</span> CVE-2021-36276
<span class="code-keyword">SHA-1   :</span> 90A76945FD2FA45FAB2B7BCFDAF6563595F94891
<span class="code-keyword">SHA-256 :</span> 2E6B339597A89E875F175023ED952AAAC64E9D20D457BBC07ACF1586E7FE2DF8
<span class="code-keyword">MD5     :</span> DACB62578B3EA191EA37486D15F4F83C

<span class="code-keyword">Name    :</span> DBUtilDrv2.inf
<span class="code-keyword">Type    :</span> Driver inf file
<span class="code-keyword">CVE ID  :</span> CVE-2021-36276
<span class="code-keyword">SHA-1   :</span> C40EBB395CB79C3CF7CA00F59F4DC17930435FC5
<span class="code-keyword">SHA-256 :</span> 4E2AA67DAAB4C4ACAC3D6D13490F93D42516FA76B8FDA87C880969FC793A3B42
<span class="code-keyword">MD5     :</span> A642273BEF0CA2D15F7D5E04673A4FC4

<span class="code-keyword">Name    :</span> DBUtilDrv2.cat
<span class="code-keyword">Type    :</span> Driver catalog file
<span class="code-keyword">CVE ID  :</span> CVE-2021-36276
<span class="code-keyword">SHA-1   :</span> 23BBC48543A46676C5CB5E33A202D261A33704FE
<span class="code-keyword">SHA-256 :</span> 4B93FC56DB034BFEBB227B1E2AF1B5E71CC663FFEFFE3B59618F634C22DB579D
<span class="code-keyword">MD5     :</span> E6CA7859C63FC37D6C4357C315F13CF4

<span class="code-keyword">Name    :</span> C9632CF058AE4321B6B0B5EA39B710FE
<span class="code-keyword">Type    :</span> Driver installer file
<span class="code-keyword">CVE ID  :</span> CVE-2021-36276
<span class="code-keyword">SHA-1   :</span> D568AC037ACA15BF5DF653F56A11021E15C29EA6
<span class="code-keyword">SHA-256 :</span> 43DBBD5D6E65A62EB820967E3A302B0EB0D29DA644BDD2177F485EAD02EF83E4
<span class="code-keyword">MD5     :</span> 014E30A60EB1497D9F88833606D3454C
</pre>
The executable driver installer file <em>C9632CF058AE4321B6B0B5EA39B710FE</em> changes slightly from one
version to the other.<br>
<br>
The vulnerability exists since 2021 and allows authenticated users to read and write to arbitrary
memory. This can be exploited for privilege escalation and code execution under high privileges.
We only use the driver to read and write the DSE variable to disable Driver Signature Enforcement.<br>
<br>
We simply install the driver, open a device handle to it and send the I/O control code <code>0x9B0C1EC4</code>
for memory reads and <code>0x9B0C1EC8</code> for memory writes. DBUtil v2.5 supports Windows 10 version 1507 and
later. Pay attention that the driver does not install on older OSs, because the dependent KMDF
library version 1.15 is not present.<br>
<br>
</t1>
<a id="topic10"></a>
<br>
<h1>
10.) DBUtil v2.6<br>
------------------</h1>
<t1>The vulnerable driver DBUtil v2.6 is shipped with many Dell tools. We will find the driver in the
Dell BIOS update tools v1.7.2 (14 Apr 2021) for OptiPlex 7070 systems. The download is still
available at the following URL:<br>
<br>
<a href="https://dl.dell.com/FOLDER07084865M/1/OptiPlex_7070_1.7.2.exe">https://dl.dell.com/FOLDER07084865M/1/OptiPlex_7070_1.7.2.exe</a><br>
<br>
We can get there from the Dell driver search page at the following URL:<br>
<br>
<a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=kygvt">https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=kygvt</a><br>
<br>
The driver is manually extracted in the same way as DBUtil v2.5. The DBUtil v2.6 driver files have
the following properties:<br>
<pre>
<span class="code-keyword">Name    :</span> DBUtilDrv2.Sys
<span class="code-keyword">Type    :</span> Driver sys file
<span class="code-keyword">CVE ID  :</span> CVE-2021-36276
<span class="code-keyword">SHA-1   :</span> 79FA541D22A2707B688890AA5F7CEB4016100823
<span class="code-keyword">SHA-256 :</span> 4720B202C4E6DD919222FE7B1F458705C0ED1CCC17EC4BA72A31EEF8559B87C7
<span class="code-keyword">MD5     :</span> 5EC88D1DD3DB03CE51DD718C7BB801ED

<span class="code-keyword">Name    :</span> DBUtilDrv2.inf
<span class="code-keyword">Type    :</span> Driver inf file
<span class="code-keyword">CVE ID  :</span> CVE-2021-36276
<span class="code-keyword">SHA-1   :</span> 03906D454CE6AD329FA9CC97BBDB0623F5F9A495
<span class="code-keyword">SHA-256 :</span> 6E8A9FA6A0354B1189A36EB9E29673050BCACB003DE8D15916491E6231E4BC1C
<span class="code-keyword">MD5     :</span> 18D6702C41EA493149E727EBB8FFD701

<span class="code-keyword">Name    :</span> DBUtilDrv2.cat
<span class="code-keyword">Type    :</span> Driver catalog file
<span class="code-keyword">CVE ID  :</span> CVE-2021-36276
<span class="code-keyword">SHA-1   :</span> 3811C12BB204041D9110ADE387C50AC6C57422E2
<span class="code-keyword">SHA-256 :</span> 2A354D4D83F21702AF61FFAAC1ACC385C77AB9ADCBB721EABD4CA812D6108D5F
<span class="code-keyword">MD5     :</span> BCA2B79EE9BFD264289C88358859671D

<span class="code-keyword">Name    :</span> C9632CF058AE4321B6B0B5EA39B710FE
<span class="code-keyword">Type    :</span> Driver installer file
<span class="code-keyword">CVE ID  :</span> CVE-2021-36276
<span class="code-keyword">SHA-1   :</span> 118BB07A29EF7129BB01C97EA6FB8AAB0FD62FB3
<span class="code-keyword">SHA-256 :</span> CAB560CDA02FA0ECB0C7F5E6B9903971A1DB93B9B2B2D708CD656DE90963D57A
<span class="code-keyword">MD5     :</span> 2AECF86EC35BAE06E8E462F71DF42B42
</pre>
The vulnerability exists since 2021 and allows authenticated users to read and write to arbitrary
memory. This can be exploited for privilege escalation and code execution under high privileges.
We only use the driver to read and write the DSE variable to disable Driver Signature Enforcement.<br>
<br>
We simply install the driver, open a device handle to it and send the I/O control code <code>0x9B0C1EC4</code>
for memory reads and <code>0x9B0C1EC8</code> for memory writes. DBUtil v2.6 supports Windows 10 version 1507 and
later. Pay attention that the driver does not install on older OSs, because the dependent KMDF
library version 1.15 is not present.<br>
<br>
</t1>
<a id="topic11"></a>
<br>
<h1>
11.) DBUtil v2.7<br>
------------------</h1>
<t1>The vulnerable driver DBUtil v2.7 is shipped with many Dell tools. We will find the driver in the
Dell BIOS update tools v1.8.4 (29 Jul 2021), v1.9.1 (26 Aug 2021), v1.10.0 (09 Nov 2021), v1.11.0
(12 Jan 2022), v1.12.0 (12 Jan 2022), v1.13.0 (14 Apr 2022), v1.15.0 (15 Jun 2022), v1.16.0 (09 Aug
2022) and v1.18.0 (07 Nov 2022) for OptiPlex 7070 systems. The downloads are still available at the
following URLs:<br>
<br>
<a href="https://dl.dell.com/FOLDER07439441M/1/OptiPlex_7070_1.8.4.exe">https://dl.dell.com/FOLDER07439441M/1/OptiPlex_7070_1.8.4.exe</a><br>
<a href="https://dl.dell.com/FOLDER07580840M/1/OptiPlex_7070_1.9.1.exe">https://dl.dell.com/FOLDER07580840M/1/OptiPlex_7070_1.9.1.exe</a><br>
<a href="https://dl.dell.com/FOLDER07775230M/1/OptiPlex_7070_1.10.0.exe">https://dl.dell.com/FOLDER07775230M/1/OptiPlex_7070_1.10.0.exe</a><br>
<a href="https://dl.dell.com/FOLDER07967056M/1/OptiPlex_7070_1.11.0.exe">https://dl.dell.com/FOLDER07967056M/1/OptiPlex_7070_1.11.0.exe</a><br>
<a href="https://dl.dell.com/FOLDER08013315M/1/OptiPlex_7070_1.12.0.exe">https://dl.dell.com/FOLDER08013315M/1/OptiPlex_7070_1.12.0.exe</a><br>
<a href="https://dl.dell.com/FOLDER08359232M/1/OptiPlex_7070_1.13.0.exe">https://dl.dell.com/FOLDER08359232M/1/OptiPlex_7070_1.13.0.exe</a><br>
<a href="https://dl.dell.com/FOLDER08572354M/1/OptiPlex_7070_1.15.0.exe">https://dl.dell.com/FOLDER08572354M/1/OptiPlex_7070_1.15.0.exe</a><br>
<a href="https://dl.dell.com/FOLDER08745871M/1/OptiPlex_7070_1.16.0.exe">https://dl.dell.com/FOLDER08745871M/1/OptiPlex_7070_1.16.0.exe</a><br>
<a href="https://dl.dell.com/FOLDER09066611M/1/OptiPlex_7070_1.18.0.exe">https://dl.dell.com/FOLDER09066611M/1/OptiPlex_7070_1.18.0.exe</a><br>
<br>
We can get there from the Dell driver search pages at the following URLs:<br>
<br>
<a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=d7wt0">https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=d7wt0</a><br>
<a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=pktf9">https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=pktf9</a><br>
<a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=w9c8g">https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=w9c8g</a><br>
<a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=dhvdy">https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=dhvdy</a><br>
<a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=jtykv">https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=jtykv</a><br>
<a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=njffg">https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=njffg</a><br>
<a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=xvvwm">https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=xvvwm</a><br>
<a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=dwdwp">https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=dwdwp</a><br>
<a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=kfnvy">https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=kfnvy</a><br>
<br>
The driver is manually extracted in the same way as DBUtil v2.5. The DBUtil v2.7 driver files have
the following properties:<br>
<pre>
<span class="code-keyword">Name    :</span> DBUtilDrv2.Sys
<span class="code-keyword">Type    :</span> Driver sys file
<span class="code-keyword">CVE ID  :</span> no CVE ID present yet
<span class="code-keyword">SHA-1   :</span> B03B1996A40BFEA72E4584B82F6B845C503A9748
<span class="code-keyword">SHA-256 :</span> 71FE5AF0F1564DC187EEA8D59C0FBC897712AFA07D18316D2080330BA17CF009
<span class="code-keyword">MD5     :</span> D104621C93213942B7B43D65B5D8D33E

<span class="code-keyword">Name    :</span> DBUtilDrv2.inf
<span class="code-keyword">Type    :</span> Driver inf file
<span class="code-keyword">CVE ID  :</span> no CVE ID present yet
<span class="code-keyword">SHA-1   :</span> 19F8DA3FE9DDBC067E3715D15AED7A6530732AB5
<span class="code-keyword">SHA-256 :</span> 56ED7FF7299C83B307282CE8D1DEF51D72A3663249E72A32C09F6264348B1DA2
<span class="code-keyword">MD5     :</span> B87944DCC444E4C6CE9BB9FB8A9C0DEF

<span class="code-keyword">Name    :</span> DBUtilDrv2.cat
<span class="code-keyword">Type    :</span> Driver catalog file
<span class="code-keyword">CVE ID  :</span> no CVE ID present yet
<span class="code-keyword">SHA-1   :</span> 06F2B629E7303AC1254B52EC0560C34D72B46155
<span class="code-keyword">SHA-256 :</span> C77C24E945ACC73D6B723F60BCDC0330FF501EEA34B7DA95061101DD1120392A
<span class="code-keyword">MD5     :</span> DE39EE41D03C97E37849AF90E408ABBE

<span class="code-keyword">Name    :</span> C9632CF058AE4321B6B0B5EA39B710FE
<span class="code-keyword">Type    :</span> Driver installer file
<span class="code-keyword">CVE ID  :</span> no CVE ID present yet
<span class="code-keyword">SHA-1   :</span> F1C876DCB8F330B976CF31BE47F9D510FD76E2D8
<span class="code-keyword">SHA-256 :</span> CD2688A74A151B03282388DADB8B6AACA309F2535C8B2B21D1243846D2B259DC
<span class="code-keyword">MD5     :</span> 94758F0D75BC41190B05EE25BA565FB9

<span class="code-keyword">Name    :</span> WdfCoinstaller01009.dll
<span class="code-keyword">Type    :</span> WdfCoinstaller for Kernel-Mode Driver Framework (KMDF) v1.9
<span class="code-keyword">CVE ID  :</span> no CVE ID present yet
<span class="code-keyword">SHA-1   :</span> C1E821B156DBC3FEB8A2DB4FDB9CF1F5A8D1BE6B
<span class="code-keyword">SHA-256 :</span> 3B9264416A78F5EAB2812CD46B14F993815E9DBF5BD145B3876C2F0F93B98521
<span class="code-keyword">MD5     :</span> 290464641660EA5CFDDA076CE6DA27C6
</pre>
The executable driver installer file "C9632CF058AE4321B6B0B5EA39B710FE" changes slightly from one
version to the other.<br>
<br>
The vulnerability exists since 2021 and allows authenticated users to read and write to arbitrary
memory. It is not yet proved the driver can be used for privilege escalation and code execution
under high privileges, but we are pretty sure it will still work. We only use the driver to read
and write the DSE variable to disable Driver Signature Enforcement.<br>
<br>
We simply install the driver, open a device handle to it and send the I/O control code <code>0x9B0C1EC4</code>
for memory reads and <code>0x9B0C1EC8</code> for memory writes. DBUtil v2.7 supports Windows 8 and later. Pay
attention that to install the driver on Windows 7 with Service Pack 1 you have to apply the Windows
update <em>KB3033929</em> for SHA256 support, because Vista and Windows 7 can only handle drivers that are
signed with the digest algorithm SHA1. This driver and the KB-Update will not work for operating
systems older than Windows 7 with Service Pack 1.<br>
<br>
</t1>
<a id="topic12"></a>
<br>
<h1>
12.) Will all these vulnerable drivers still work?<br>
--------------------------------------------------<br>
</h1>
<t1>At first we had the same question and thought <em>for sure this does not work anymore, because
Microsoft will do an instant patch to fix the security flaws</em>. After some research we recognized
that the answer is more complicated than that. As of now all the above 5 drivers used by DSE-Patcher
will still work on any listed operating systems including the newest Windows 10 and Windows 11 x64
Build 22H2. Only DBUtil v2.3 is blocked on the newest Windows 11 x64 Build 22H2, due to an updated
driver blocklist.<br>
<br>
The problem is not by Microsoft alone, because the driver vendors and creators have to
revoke the signing certificates of the driver. Dell for example does not revoke the certificates for
DBUtil v2.3, v2.5, v2.6 and v2.7, because the certs are also used to sign other applications and
drivers, which will stop working after the certificate is blocked globally inside the OS. This means
that the above security vulnerabilities may be present many years from now on. At the moment we can
not even find a CVE entry for the newest driver DBUtil v2.7. The best way to stop these exploits
would be revoking a certificate associated with the vulnerable driver. The only way to stop malware
using these exploited drivers is to blacklist them manually.<br>
<br>
</t1>
<a id="topic13"></a>
<br>
<h1>
13.) How to block vulnerable drivers?<br>
----------------------------------------<br>
</h1>
<t1>Since Windows 10 Build 1903, Windows 11 and Windows Server 2016 and above Microsoft introduced the
so called <em>Windows Defender Application Control</em> (WDAC) policies. Only these Windows versions
support WDAC policies. Older operating systems are not supported. We did not find a way to block the
vulnerable drivers on older Windows operating systems. AppLocker does not work at kernel driver level
and blocking the certificates in the cert manager does nothing at all.<br>
<br>
To create an example WDAC policies for all 5 vulnerable drivers that are supported by DSE-Patcher do
the following steps:<br>
<ul>
<li>create an empty XML file <em>C:\Users\Public\DriverBlocklist.xml</em>, copy this content to the file and
save it:</li>
<pre>
<span class="code-keyword">&lt;?xml</span> version="1.0" encoding="utf-8"?<span class="code-keyword">&gt;</span>
<span class="code-keyword">&lt;SiPolicy</span> xmlns="urn:schemas-microsoft-com:sipolicy"<span class="code-keyword">&gt;</span>
  <span class="code-keyword">&lt;VersionEx&gt;</span>10.0.25210.0<span class="code-keyword">&lt;/VersionEx&gt;</span>
  <span class="code-keyword">&lt;PlatformID&gt;</span>{2E07F7E4-194C-4D20-B7C9-6F44A6C5A234}<span class="code-keyword">&lt;/PlatformID&gt;</span>
  <span class="code-keyword">&lt;Rules&gt;</span>
    <span class="code-keyword">&lt;Rule&gt;</span>
      <span class="code-keyword">&lt;Option&gt;</span>Enabled:Unsigned System Integrity Policy<span class="code-keyword">&lt;/Option&gt;</span>
    <span class="code-keyword">&lt;/Rule&gt;</span>
    <span class="code-keyword">&lt;Rule&gt;</span>
      <span class="code-keyword">&lt;Option&gt;</span>Enabled:Advanced Boot Options Menu<span class="code-keyword">&lt;/Option&gt;</span>
    <span class="code-keyword">&lt;/Rule&gt;</span>
    <span class="code-comment">&lt;!--</span>
    <span class="code-comment">&lt;Rule&gt;</span>
      <span class="code-comment">&lt;Option&gt;Enabled:Audit Mode&lt;/Option&gt;</span>
    <span class="code-comment">&lt;/Rule&gt;</span>
    <span class="code-comment">--&gt;</span>
    <span class="code-keyword">&lt;Rule&gt;</span>
      <span class="code-keyword">&lt;Option&gt;</span>Disabled:Script Enforcement<span class="code-keyword">&lt;/Option&gt;</span>
    <span class="code-keyword">&lt;/Rule&gt;</span>
    <span class="code-keyword">&lt;Rule&gt;</span>
      <span class="code-keyword">&lt;Option&gt;</span>Enabled:Update Policy No Reboot<span class="code-keyword">&lt;/Option&gt;</span>
    <span class="code-keyword">&lt;/Rule&gt;</span>
  <span class="code-keyword">&lt;/Rules&gt;</span>
  <span class="code-comment">&lt;!--File Rules--&gt;</span>
  <span class="code-keyword">&lt;FileRules&gt;</span>
    <span class="code-keyword">&lt;Allow</span> ID="ID_ALLOW_ALL_1" FriendlyName="" FileName="*" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Allow</span> ID="ID_ALLOW_ALL_2" FriendlyName="" FileName="*" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_RTCORE_64_SHA1" FriendlyName="64-bit MSI RTCore64 v4.6.2 RTCore64.sys Hash Sha1" Hash="4A68C2D7A4C471E062A32C83A36EEDB45A619683" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_RTCORE_64_SHA256" FriendlyName="64-bit MSI RTCore64.sys Hash Sha256" Hash="478C36F8AF7844A80E24C1822507BEEF6314519185717EC7AE224A0E04B2F330" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_RTCORE_64_SHA1_PAGE" FriendlyName="64-bit MSI RTCore64.sys Hash Page Sha1" Hash="84152FA241C3808F8C7752964589C957E440403F" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_RTCORE_64_SHA256_PAGE" FriendlyName="64-bit MSI RTCore64.sys Hash Page Sha256" Hash="A807532037A3549AE3E046F183D782BCB78B6193163EA448098140563CF857CB" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_DBUTIL_V23_64_SHA1" FriendlyName="64-bit Dell DBUtil v2.3 DBUtil_2_3.Sys Hash Sha1" Hash="E3C1DD569AA4758552566B0213EE4D1FE6382C4B" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_DBUTIL_V23_64_SHA256" FriendlyName="64-bit Dell DBUtil v2.3 DBUtil_2_3.Sys Hash Sha256" Hash="FE4270A61DBED978C28B2915FCC2826D011148DCB7533FA8BD072DDCE5944CEF" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_DBUTIL_V23_64_SHA1_PAGE" FriendlyName="64-bit Dell DBUtil v2.3 DBUtil_2_3.Sys Hash Page Sha1" Hash="E09B5E80805B8FE853EA27D8773E31BFF262E3F7" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_DBUTIL_V23_64_SHA256_PAGE" FriendlyName="64-bit Dell DBUtil v2.3 DBUtil_2_3.Sys Hash Page Sha256" Hash="7E2AD3D6D76F4FCD4583B865FFC12DE6C44FC16CBCBB81D480CB067F2A860422" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_DBUTIL_V25_64_SHA1" FriendlyName="64-bit Dell DBUtil v2.5 DBUtilDrv2.sys Hash Sha1" Hash="6BC2AB0F03D7A58685A165B519E8FEE6937526A6" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_DBUTIL_V25_64_SHA256" FriendlyName="64-bit Dell DBUtil v2.5 DBUtilDrv2.sys Hash Sha256" Hash="D7C683EF033AC2DC4DFA0DC61F39931F91C0E8FD19E613F664CB03E14112EF6E" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_DBUTIL_V25_64_SHA1_PAGE" FriendlyName="64-bit Dell DBUtil v2.5 DBUtilDrv2.sys Hash Page Sha1" Hash="66B2E2438725B576428CBEAE3E481148B4B5FD8C" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_DBUTIL_V25_64_SHA256_PAGE" FriendlyName="64-bit Dell DBUtil v2.5 DBUtilDrv2.sys Hash Page Sha256" Hash="C60578FAD95216EF74BCD9661A562C0DDC2C8697D64B546F59A7EF85F71D3814" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_DBUTIL_V26_64_SHA1" FriendlyName="64-bit Dell DBUtil v2.6 DBUtilDrv2.sys Hash Sha1" Hash="4D1E9A5F3F05F244E68286723E70F3202FB4E4A5" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_DBUTIL_V26_64_SHA256" FriendlyName="64-bit Dell DBUtil v2.6 DBUtilDrv2.sys Hash Sha256" Hash="462CD6DB3C0BE714DD751466D5871C111812FAF392C468C81A88CB0DA4783458" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_DBUTIL_V26_64_SHA1_PAGE" FriendlyName="64-bit Dell DBUtil v2.6 DBUtilDrv2.sys Hash Page Sha1" Hash="D66BC7C933EC056A9B303AE9A094CC6DA1F83823" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_DBUTIL_V26_64_SHA256_PAGE" FriendlyName="64-bit Dell DBUtil v2.6 DBUtilDrv2.sys Hash Page Sha256" Hash="68D50D19203D6045C9385B4B5D2CC92A8F3946507F5BC1E566B79C18E89DDB8D" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_DBUTIL_V27_64_SHA1" FriendlyName="64-bit Dell DBUtil v2.7 DBUtilDrv2.sys Hash Sha1" Hash="D46AE9BCC746CA408FBB55FB0D61B638720A8F25" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_DBUTIL_V27_64_SHA256" FriendlyName="64-bit Dell DBUtil v2.7 DBUtilDrv2.sys Hash Sha256" Hash="7BACB353363CC29F7F3815A9D01E85CD86202D92378D1AB1B11DF1AB2F42F40A" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_DBUTIL_V27_64_SHA1_PAGE" FriendlyName="64-bit Dell DBUtil v2.7 DBUtilDrv2.sys Hash Page Sha1" Hash="F0A5923AEF58A074FC1E388BDF086078BFC514EB" <span class="code-keyword">/&gt;</span>
    <span class="code-keyword">&lt;Deny</span> ID="ID_DENY_DBUTIL_V27_64_SHA256_PAGE" FriendlyName="64-bit Dell DBUtil v2.7 DBUtilDrv2.sys Hash Page Sha256" Hash="17AE4DFC31BDE054108E5598551515F4B4B46367F6D4324F087201B8038A4E3D" <span class="code-keyword">/&gt;</span>
  <span class="code-keyword">&lt;/FileRules&gt;</span>
  <span class="code-comment">&lt;!--Driver Signing Scenarios--&gt;</span>
  <span class="code-keyword">&lt;SigningScenarios&gt;</span>
    <span class="code-keyword">&lt;SigningScenario</span> Value="131" ID="ID_SIGNINGSCENARIO_DRIVERS_1" FriendlyName="Auto generated policy on 09-19-2022"<span class="code-keyword">&gt;</span>
      <span class="code-keyword">&lt;ProductSigners&gt;</span>
        <span class="code-keyword">&lt;FileRulesRef&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_ALLOW_ALL_1" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_RTCORE_64_SHA1" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_RTCORE_64_SHA256" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_RTCORE_64_SHA1_PAGE" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_RTCORE_64_SHA256_PAGE" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_DBUTIL_V23_64_SHA1" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_DBUTIL_V23_64_SHA256" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_DBUTIL_V23_64_SHA1_PAGE" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_DBUTIL_V23_64_SHA256_PAGE" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_DBUTIL_V25_64_SHA1" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_DBUTIL_V25_64_SHA256" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_DBUTIL_V25_64_SHA1_PAGE" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_DBUTIL_V25_64_SHA256_PAGE" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_DBUTIL_V26_64_SHA1" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_DBUTIL_V26_64_SHA256" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_DBUTIL_V26_64_SHA1_PAGE" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_DBUTIL_V26_64_SHA256_PAGE" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_DBUTIL_V27_64_SHA1" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_DBUTIL_V27_64_SHA256" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_DBUTIL_V27_64_SHA1_PAGE" <span class="code-keyword">/&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_DENY_DBUTIL_V27_64_SHA256_PAGE" <span class="code-keyword">/&gt;</span>
        <span class="code-keyword">&lt;/FileRulesRef&gt;</span>
      <span class="code-keyword">&lt;/ProductSigners&gt;</span>
    <span class="code-keyword">&lt;/SigningScenario&gt;</span>
    <span class="code-keyword">&lt;SigningScenario</span> Value="12" ID="ID_SIGNINGSCENARIO_WINDOWS" FriendlyName="Auto generated policy on 09-19-2022"<span class="code-keyword">&gt;</span>
      <span class="code-keyword">&lt;ProductSigners&gt;</span>
        <span class="code-keyword">&lt;FileRulesRef&gt;</span>
          <span class="code-keyword">&lt;FileRuleRef</span> RuleID="ID_ALLOW_ALL_2" <span class="code-keyword">/&gt;</span>
        <span class="code-keyword">&lt;/FileRulesRef&gt;</span>
      <span class="code-keyword">&lt;/ProductSigners&gt;</span>
    <span class="code-keyword">&lt;/SigningScenario&gt;</span>
  <span class="code-keyword">&lt;/SigningScenarios&gt;</span>
  <span class="code-keyword">&lt;HvciOptions&gt;</span>0<span class="code-keyword">&lt;/HvciOptions&gt;</span>
  <span class="code-keyword">&lt;Settings&gt;</span>
    <span class="code-keyword">&lt;Setting</span> Provider="PolicyInfo" Key="Information" ValueName="Name"<span class="code-keyword">&gt;</span>
      <span class="code-keyword">&lt;Value&gt;</span>
        <span class="code-keyword">&lt;String&gt;</span>Microsoft Windows Driver Policy<span class="code-keyword">&lt;/String&gt;</span>
      <span class="code-keyword">&lt;/Value&gt;</span>
    <span class="code-keyword">&lt;/Setting&gt;</span>
    <span class="code-keyword">&lt;Setting</span> Provider="PolicyInfo" Key="Information" ValueName="Id"<span class="code-keyword">&gt;</span>
      <span class="code-keyword">&lt;Value&gt;</span>
        <span class="code-keyword">&lt;String&gt;</span>10.0.25210.0<span class="code-keyword">&lt;/String&gt;</span>
      <span class="code-keyword">&lt;/Value&gt;</span>
    <span class="code-keyword">&lt;/Setting&gt;</span>
  <span class="code-keyword">&lt;/Settings&gt;</span>
  <span class="code-keyword">&lt;PolicyTypeID&gt;</span>{A244370E-44C9-4C06-B551-F6016E563076}<span class="code-keyword">&lt;/PolicyTypeID&gt;</span>
<span class="code-keyword">&lt;/SiPolicy&gt;</span>
</pre>

<li>open Windows PowerShell as administrator and enter the following commands to apply the policy:<br>
<pre>
<span class="code-comment"># convert policy to binary form and save it to "C:\Windows\System32\CodeIntegrity\SiPolicy.p7b"</span>
<span class="code-keyword">ConvertFrom-CIPolicy</span> -XmlFilePath "C:\Users\Public\DriverBlocklist.xml" -BinaryFilePath "$Env:windir\System32\CodeIntegrity\SiPolicy.p7b"
<span class="code-comment"># update policy without reboot</span>
<span class="code-keyword">Invoke-CimMethod</span> -Namespace "root\Microsoft\Windows\CI" -ClassName PS_UpdateAndCompareCIPolicy -MethodName Update -Arguments @{ FilePath = "$Env:windir\System32\CodeIntegrity\SiPolicy.p7b" }</pre></li>
</ul>
Directly afterwards DSE-Patcher does not work anymore. The drivers can be unpacked, but not
installed and are successfully blocked in Windows. In Event Viewer we see the following events in
the category System and Security:<br>
<br>
<img src="images/Driver_blocked_EventViewer_System.png"/><br>
<br>
<img src="images/Driver_blocked_EventViewer_Security.png"/><br>
<br>
If you want to add a custom vulnerable driver to the XML file, you have to calculate the SHA1 and
SHA256 hashes and page hashes. These differ from the normal SHA1 and SHA256 file hash, because some
data like the executable checksum and the appended certificates are left out. An easy way to
calculate the correct Authenticode checksums is to use the tool <em>Authenticode Hash Calc</em> by
<em>hfiref0x</em>. You can download the source code and the binary at the following URL:<br>
<br>
<a href="https://github.com/hfiref0x/AuthHashCalc">https://github.com/hfiref0x/AuthHashCalc</a><br>
<br>
</t1>
<a id="topic14"></a>
<br>
<h1>
14.) Credits and Download Link<br>
----------------------------------</h1>
<t1>A <b>BIG THANKS</b> goes out to the following coders:<br>
<ul>
<li><b>hfiref0x</b> (<a href="https://github.com/hfiref0x/DSEFix">DSEFix</a>, <a href="https://github.com/hfiref0x/KDU">Kernel Driver Utility</a>, <a href="https://github.com/hfiref0x/AuthHashCalc">Authenticode Hash Calculator</a>)</li>
<li><b>Vyacheslav Patkov</b> (<a href="http://www.patkov-site.narod.ru/download/hde.zip">Hacker Disassembler Engine 64</a>)</li>
</ul>
The complete DSE-Patcher package with all necessary files can be downloaded from <a href="https://sourceforge.net/projects/DSE-Patcher/">Sourceforge</a>.<br>
<br>
Thanks for your attention and interest in this topic.<br>
Greets <b>Kai Schtrom</b><br>
<br>
Version 1.0 Nov 27, 2022<br>
<br>
<br>
</t1>
</div>
<div class="rightpane"><h1></h1></div>
</body>
</html>
